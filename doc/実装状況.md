# Appointy 実装状況レポート

## 🎉 デュアルモードシステム概要 (2025-07-13更新)

Appointyはデュアルモード対応の統一ユーザーシステムを採用し、以下の特徴を持っています：

### 🔄 モード切り替えシステム
- **お客さまモード**: 白いヘッダー、予約・履歴中心のUI
- **店舗モード**: 青いヘッダー、店舗管理中心のUI  
- **ワンクリック切り替え**: ヘッダーボタンで即座にモード変更
- **動的ヘッダー**: 予約ページは来た場所に応じて自動切替

### 🏗️ システム設計
- **統一認証**: すべてのユーザーが同一のログイン・登録システムを使用
- **段階的権限**: ユーザー → 店舗運営者への段階的な権限昇格
- **任意店舗運営**: ユーザーは任意で店舗を開設可能（1ユーザー1店舗まで）
- **マルチテナント対応**: 複数店舗の独立運営が可能

## アーキテクチャ

### データベース設計
```
users (全ユーザー共通)
  ↓ 1:0..1
stores (店舗情報)
  ↓ 1:N
services (サービス情報)
  ↓ 1:N
reservations (予約情報)
  ↑ N:1
users (予約者として)
```

### 認証・認可フロー
1. **統一ログイン** → ダッシュボード
2. **店舗有無判定** → ユーザー機能 or ユーザー+店舗機能
3. **店舗開設** → 店舗管理機能追加

## 実装済み画面一覧（モード別）

### 🌐 パブリック画面

| 画面名 | パス | 説明 | ステータス |
|--------|------|------|----------|
| トップページ | `/` | ランディングページ、サービス紹介 | ✅ 完了 |

### 🔐 認証画面

| 画面名 | パス | 説明 | ステータス |
|--------|------|------|----------|
| 統一ログイン | `/login` | 全ユーザー共通ログイン | ✅ 完了 |
| ユーザー登録 | `/register` | 新規ユーザー登録 | ✅ 完了 |

### 🌟 お客さまモード（白いヘッダー）

| 画面名 | パス | 説明 | ステータス |
|--------|------|------|----------|
| 予約ページ | `/booking` | サービス閲覧・フリーワード検索・予約作成（白ヘッダー）| ✅ 完了 |
| マイページ | `/dashboard` | ユーザーダッシュボード | ✅ 完了 |
| 予約履歴 | `/reservations` | 予約履歴確認・キャンセル・チャット | ✅ 完了 |
| プロフィール設定 | `/profile` | ユーザー情報編集 | ✅ 完了 |
| 店舗開設 | `/store/register` | 新規店舗登録 | ✅ 完了 |

### 🏪 店舗モード（青いヘッダー）

| 画面名 | パス | 説明 | ステータス |
|--------|------|------|----------|
| 予約ページ | `/booking?mode=owner` | サービス閲覧・予約作成（青ヘッダー）| ✅ 完了 |
| 店舗ダッシュボード | `/owner/dashboard` | 店舗統計・予約状況確認 | ✅ 完了 |
| サービス管理 | `/owner/services` | サービスCRUD・価格設定 | ✅ 完了 |
| 予約管理 | `/owner/reservations` | 予約一覧・詳細確認・管理・チャット | ✅ 完了 |
| 店舗設定 | `/owner/settings` | 店舗情報・営業時間設定 | ✅ 完了 |

### 📱 共通コンポーネント

| コンポーネント名 | 説明 | ステータス |
|-------------|------|----------|
| AppHeader.vue | 統一ヘッダー（モード切り替え対応）| ✅ 完了 |
| Modal.vue | 汎用モーダルコンポーネント | ✅ 完了 |

## 🎯 主要機能実装状況

### ✅ モード切り替えシステム
- **デュアルヘッダー**: 白（お客さま）/青（店舗）の自動切り替え
- **動的予約ページ**: 来た場所に応じてヘッダー自動選択
- **ワンクリック切り替え**: ヘッダーボタンでモード瞬時変更
- **統一コンポーネント**: AppHeader.vueで全モード管理

### ✅ 統一認証システム
- **JWTベース認証**: HTTPOnlyクッキーによる安全な認証
- **段階的権限昇格**: ユーザー → 店舗オーナーへのスムーズな移行
- **1ユーザー1店舗制約**: UNIQUE制約による適切な権限管理

### ✅ 予約システム
- **マルチテナント対応**: 複数店舗の独立した予約管理
- **認証必須予約**: customer_idによる予約者紐付け
- **動的時間枠**: 営業時間とサービス時間に基づく自動調整

## API実装状況

### ✅ 統一認証API

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/auth/login` | POST | 統一ユーザーログイン | ✅ 完了 |
| `/api/auth/register` | POST | 統一ユーザー登録 | ✅ 完了 |
| `/api/auth/me` | GET | 認証ユーザー情報取得（hasStore含む） | ✅ 完了 |
| `/api/auth/logout` | POST | ログアウト | ✅ 完了 |

### ✅ 店舗登録API

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/store/register` | POST | 店舗登録（1ユーザー1店舗） | ✅ 完了 |

### ✅ 顧客予約API（認証必須）

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/customer/reservations` | GET | 予約履歴取得 | ✅ 完了 |
| `/api/customer/reservations/[id]/cancel` | POST | 予約キャンセル（24時間前まで） | ✅ 完了 |

### ✅ 店舗管理API（店舗所有必須）

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/owner/services` | GET | サービス一覧取得（store_id基準） | ✅ 完了 |
| `/api/owner/services` | POST | サービス作成（store_id基準） | ✅ 完了 |
| `/api/owner/services/[id]` | GET | サービス詳細取得 | ✅ 完了 |
| `/api/owner/services/[id]` | PUT | サービス更新 | ✅ 完了 |
| `/api/owner/services/[id]` | DELETE | サービス削除 | ✅ 完了 |
| `/api/owner/reservations` | GET | 予約一覧取得（store_id基準、検索・フィルター対応） | ✅ 完了 |
| `/api/owner/reservations/[id]` | GET | 予約詳細取得 | ✅ 完了 |
| `/api/owner/reservations/[id]` | DELETE | 予約キャンセル | ✅ 完了 |
| `/api/owner/reservations/[id]/confirm` | PUT | 予約承認 | ✅ 完了 |
| `/api/owner/reservations/[id]/reject` | PUT | 予約拒否 | ✅ 完了 |
| `/api/owner/profile` | GET | 店舗プロフィール取得 | ✅ 完了 |
| `/api/owner/profile` | PUT | 店舗プロフィール更新 | ✅ 完了 |
| `/api/owner/profile/image` | POST | 店舗画像アップロード | ✅ 完了 |

### ✅ プロフィールAPI（認証必須）

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/profile` | PUT | ユーザープロフィール更新 | ✅ 完了 |
| `/api/profile/image` | POST | プロフィール画像アップロード | ✅ 完了 |
| `/api/profile/image` | DELETE | プロフィール画像削除 | ✅ 完了 |

### ✅ 公開API

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/public/profile` | GET | 店舗プロフィール取得（stores基準、店舗ID指定可能） | ✅ 完了 |
| `/api/public/services` | GET | 全店舗サービス一覧取得（店舗名含む、検索・フィルター対応） | ✅ 完了 |
| `/api/public/services/[id]` | GET | サービス詳細取得 | ✅ 完了 |
| `/api/public/available-slots` | GET | 予約可能時間取得（店舗・サービス基準） | ✅ 完了 |
| `/api/public/reservations` | POST | 予約作成（認証必須、customer_id基準、pending状態） | ✅ 完了 |

### ✅ 予約メッセージAPI（認証必須）

| エンドポイント | メソッド | 説明 | ステータス |
|---------------|---------|------|----------|
| `/api/reservations/[id]/messages` | GET | 予約メッセージ一覧取得 | ✅ 完了 |
| `/api/reservations/[id]/messages` | POST | 予約メッセージ送信 | ✅ 完了 |

## データベース実装状況

### ✅ 統一データベーススキーマ（INTEGER型ID）

| テーブル | 説明 | ステータス |
|---------|------|----------|
| users | 全ユーザー共通（認証情報のみ、INTEGER PK） | ✅ 完了 |
| stores | 店舗情報（users 1:0..1 stores、INTEGER PK） | ✅ 完了 |
| services | サービス情報（stores 1:N services、categoryカラム追加） | ✅ 完了 |
| reservations | 予約情報（services 1:N reservations, users 1:N reservations、承認フロー対応） | ✅ 完了 |
| reservation_messages | 予約メッセージ（reservations 1:N messages） | ✅ 完了 |

### ✅ 主要機能実装状況

#### 認証・認可システム
- ✅ 統一ユーザー認証（JWT + httpOnly Cookie）
- ✅ 段階的権限管理（ユーザー → 店舗運営者）
- ✅ ミドルウェアによる認証・認可チェック

#### 店舗管理システム
- ✅ 店舗登録（1ユーザー1店舗制限）
- ✅ 店舗プロフィール管理
- ✅ 画像アップロード（MinIO連携）
- ✅ 営業時間設定
- ✅ マルチテナント対応（store_id基準）

#### 予約システム
- ✅ 認証必須予約作成（customer_id基準）
- ✅ 予約承認フロー（pending → confirmed）
- ✅ 予約履歴管理
- ✅ 予約キャンセル（24時間前まで）
- ✅ 営業時間基準の予約可能時間計算
- ✅ 重複予約防止
- ✅ 予約メッセージ機能（リアルタイムチャット）

#### サービス管理
- ✅ サービスCRUD（店舗単位）
- ✅ アクティブ/非アクティブ管理
- ✅ デフォルトサービス自動作成
- ✅ カテゴリ別サービス管理
- ✅ フリーワード検索機能

## 主要な設計変更・改善点

### 🔄 統一ユーザーシステムへの移行

#### Before（旧仕様）
- オーナーとカスタマーで完全分離
- 別々の認証システム
- user_idベースのデータ管理

#### After（現在の実装）
- 統一ユーザーシステム
- 段階的権限管理（ユーザー → 店舗運営者）
- store_idベースのマルチテナント対応

### 🎯 UX改善

#### 認証フロー
- 複雑な認証選択を廃止
- 統一ログイン・登録画面
- 自動的な権限判定とダッシュボード表示
- ログイン状態に応じた動的ナビゲーション
- 予約完了後の適切なリダイレクト

#### 予約フロー
- 認証必須による安全性向上
- 予約履歴・キャンセル機能追加
- 再予約機能による利便性向上
- 全店舗サービス表示による選択肢拡大
- 店舗名表示による分かりやすい選択

#### 店舗管理フロー
- 店舗所有者ダッシュボードにユーザー名表示
- 予約管理画面から予約画面への導線追加
- 詳細モーダルによる予約情報確認

### 📊 技術的改善

#### データベース設計
- マルチテナント対応
- 正規化されたリレーション
- 拡張性の高いスキーマ

#### API設計
- RESTful設計の統一
- 適切な認証・認可
- 型安全なレスポンス
- SQLiteのboolean値問題解決
- マルチテナント対応のサービス表示

## 今後の拡張計画

### 短期（1-2週間）
- **メール通知機能**: 予約確認・リマインドメール
- **パスワードリセット**: セキュリティ機能強化

### 中期（1ヶ月）
- **カレンダー表示**: 視覚的な予約管理
- **レポート機能**: 売上・予約統計

### 長期（3ヶ月）
- **決済連携**: オンライン決済対応
- **マルチ店舗管理**: 1ユーザー複数店舗対応
- **モバイルアプリ**: PWA対応

## 技術スタック

- **フロントエンド**: Nuxt 3, Vue 3, TypeScript, Tailwind CSS
- **バックエンド**: Nuxt Server API (h3)
- **データベース**: SQLite (開発), better-sqlite3
- **認証**: JWT + httpOnly Cookie
- **ストレージ**: MinIO (開発), Cloudflare R2 (本番)
- **バリデーション**: Zod
- **パスワードハッシュ化**: bcryptjs
- **開発環境**: Docker + Docker Compose

## 成果物

### ✅ 完成したドキュメント
- 📋 **画面遷移図**: 統一システムの画面フロー
- 📚 **API仕様書**: 統一認証・店舗登録・顧客予約API
- 🗄️ **ER図**: store_idベースのマルチテナントスキーマ
- 📊 **実装状況**: 完全な機能一覧と技術仕様

### ✅ 実装された機能
- 🔐 **統一認証システム**: ログイン・登録・権限管理
- 🏪 **店舗管理システム**: 登録・プロフィール・サービス・予約管理
- 📅 **予約システム**: 作成・履歴・キャンセル・再予約
- 🖼️ **画像管理**: MinIO連携アップロード・表示

## 最新の修正・改善点（2025-07-12）

### 🔧 技術的な問題解決
- **SQLiteのboolean値問題**: サービス作成・更新時のis_activeフィールドで数値変換を実装
- **予約完了後のログアウト問題**: 認証状態管理とリダイレクト処理を修正
- **Hydration mismatch**: blankレイアウトの不要なDOM要素を削除

### 🌟 UX/UI改善
- **全店舗サービス表示**: 予約画面で全店舗のサービスを表示、店舗名も併記
- **動的ナビゲーション**: ログイン状態に応じたヘッダーメニューの動的表示
- **予約画面への導線**: owner/dashboard、owner/reservationsから予約画面確認ボタンを追加
- **ユーザー名表示**: 店舗所有者ダッシュボードにユーザー名を表示

### 🎛️ システム管理機能
- **SQLite Web管理ツール**: Docker環境でのデータベース管理ツール追加（http://127.0.0.1:8080）
- **予約詳細確認**: 店舗所有者向けの予約詳細モーダル機能

---
---
**📅 最終更新: 2025-07-18 - 全ページモダンデザイン更新完了**

### 🎉 2025-07-18 更新内容
- **全ページモダンデザイン更新**: 統一されたモダンなUI/UXデザインに全面リニューアル
- **グラデーションデザイン**: 背景、ボタン、テキストにグラデーション効果を適用
- **カードデザイン強化**: 透明度調整、強い影、ホバーエフェクトの追加
- **インタラクション改善**: ボタンのスケールエフェクト、スムーズなトランジション
- **視認性向上**: 白すぎる背景を改善、コントラストを強化
- **統一されたスタイル**: 全ページで一貫したデザイン言語を適用

### 🎉 2025-07-17 更新内容
- **予約承認フロー**: pending → confirmed の承認システム実装
- **チャット機能**: 予約に関するリアルタイムメッセージ機能完全実装（顧客・店舗双方）
- **フリーワード検索**: サービス名、店舗名、説明文、カテゴリでの検索機能追加
- **予約管理UI強化**: 承認待ち統計、一覧での承認/拒否ボタン、チャット機能を統合
- **API仕様書更新**: 予約管理、公開API、メッセージAPIの仕様書完全更新
- **ER図更新**: reservation_messagesテーブル、confirmed_atカラム追加を反映

### 🎉 2025-07-16 更新内容
- **データベース設計改善**: TEXT（UUID）からINTEGER（AUTO_INCREMENT）への変更
- **予約URL構造改善**: `/store/[storeId]/service/[serviceId]`による個別サービス予約ページ
- **設計書完全更新**: システム設計書、API仕様書、ER図、画面遷移図を実装に合わせて修正
- **プロフィールAPI完成**: ユーザープロフィール更新・画像アップロード・削除機能の実装
- **データベース再構築**: profile_image_keyカラム追加によるプロフィール画像機能完全対応

### 🎉 2025-07-13 更新内容
- **モード切り替えシステム**: お客さまモード/店舗モードの完全分離
- **統一ヘッダーコンポーネント**: AppHeader.vueによる一元管理
- **動的UI切り替え**: 来た場所に応じた自動ヘッダー選択
- **UX大幅改善**: 直感的なナビゲーションと混乱解消