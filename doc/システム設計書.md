# Appointy システム設計書

## 1. システム概要

### 1.1 目的
小規模な店舗や個人事業主向けの予約管理システムを提供し、顧客がオンラインで簡単に予約できる環境を構築する。

### 1.2 システム構成
- **フロントエンド**: Nuxt 3 + Tailwind CSS（Cloudflare Pages）
- **バックエンド**: Nuxt 3 Server API（Cloudflare Workers）
- **データベース**: Cloudflare D1（SQLite）
- **ファイルストレージ**: Cloudflare R2
- **メール送信**: MailChannels

## 2. アーキテクチャ設計

### 2.1 全体構成図
```
┌─────────────────┐     ┌─────────────────┐
│   顧客端末      │     │ オーナー端末    │
└────────┬────────┘     └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     │
              ┌──────▼──────┐
              │ Cloudflare  │
              │   Pages     │
              │ (Frontend)  │
              └──────┬──────┘
                     │
              ┌──────▼──────┐
              │ Cloudflare  │
              │  Workers    │
              │ (Backend)   │
              └──┬────┬────┬─┘
                 │    │    │
    ┌────────────▼┐  ┌▼────┐┌▼──────────┐
    │Cloudflare D1│  │ R2  ││MailChannels│
    │ (Database)  │  │     ││            │
    └─────────────┘  └─────┘└────────────┘
```

### 2.2 レイヤー構成
1. **プレゼンテーション層**
   - Vue 3コンポーネント（Nuxt 3）
   - Tailwind CSSによるスタイリング

2. **アプリケーション層**
   - Nuxt 3 Server API
   - 認証・認可処理
   - ビジネスロジック実装

3. **データ層**
   - Cloudflare D1（SQLite）
   - Cloudflare R2（オブジェクトストレージ）

## 3. セキュリティ設計

### 3.1 認証・認可
- **認証方式**: JWTトークンベース認証
- **パスワード**: bcryptによるハッシュ化
- **セッション管理**: HTTPOnly Cookieに保存

### 3.2 アクセス制御
- 店舗オーナー専用エンドポイントの保護
- CORSポリシーの適切な設定
- CSRFトークンによる保護

### 3.3 データ保護
- HTTPS通信の強制
- SQLインジェクション対策（プリペアドステートメント使用）
- XSS対策（Vue.jsの自動エスケープ機能）

## 4. 画面設計

### 4.1 店舗オーナー側画面
| 画面名 | パス | 説明 |
|--------|------|------|
| ログイン | `/owner/login` | メールアドレスとパスワードでログイン |
| ダッシュボード | `/owner/dashboard` | 予約カレンダー表示 |
| サービス管理 | `/owner/services` | サービスのCRUD操作 |
| 設定 | `/owner/settings` | プロフィール編集、画像アップロード |

### 4.2 顧客側画面
| 画面名 | パス | 説明 |
|--------|------|------|
| 予約カレンダー | `/` | 店舗情報表示、サービス選択と空き時間確認 |
| 予約フォーム | `/book` | 顧客情報入力 |
| 完了画面 | `/thanks` | 予約完了確認 |

## 5. API設計

### 5.1 店舗オーナー向けAPI（認証必須）
- `/api/auth/*` - 認証関連
- `/api/owner/services/*` - サービス管理
- `/api/owner/reservations/*` - 予約管理（一覧・キャンセル）
- `/api/owner/profile/*` - プロフィール管理

### 5.2 公開API（認証不要）
- `/api/public/profile` - 店舗プロフィール取得
- `/api/public/services/*` - サービス一覧・詳細取得
- `/api/public/available-slots` - 予約可能時間取得
- `/api/public/reservations` - 予約作成

## 6. 機能設計

### 6.1 認証機能
- ログイン/ログアウト
- セッション管理
- パスワードリセット（将来実装）

### 6.2 サービス管理機能
- サービスの登録・編集・削除
- 料金・所要時間の設定
- サービスの有効/無効切り替え

### 6.3 予約管理機能
- カレンダー表示
- 予約の詳細確認
- 予約のキャンセル
- 予約可能時間の自動計算

### 6.4 プロフィール管理機能
- 基本情報の編集
- プロフィール画像のアップロード
- 営業時間の設定

### 6.5 通知機能
- 予約確認メール送信
- リマインドメール送信（予約前日）
- キャンセル通知

## 7. 非機能要件

### 7.1 パフォーマンス
- ページロード時間: 3秒以内
- API応答時間: 1秒以内
- 同時接続数: 100ユーザー

### 7.2 可用性
- Cloudflareのグローバルネットワークによる高可用性
- 自動スケーリング対応

### 7.3 拡張性
- マイクロサービスアーキテクチャ
- APIファーストな設計

## 8. 開発・デプロイ戦略

### 8.1 開発環境
- VSCode DevContainer使用
- SQLite（ローカル開発）
- MinIO（R2の代替）

### 8.2 デプロイメント
- GitHubからCloudflare Pagesへの自動デプロイ
- 環境変数による設定管理
- ステージング環境の構築

## 9. 監視・運用

### 9.1 ログ管理
- Cloudflare Workers Logsの活用
- エラー通知の設定

### 9.2 メトリクス
- アクセス数の監視
- API応答時間の監視
- エラー率の監視

### 9.3 バックアップ
- D1データベースの定期バックアップ
- R2オブジェクトのバージョニング