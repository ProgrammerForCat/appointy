# Appointy システム設計書

## 1. システム概要

### 1.1 目的
小規模な店舗や個人事業主向けの予約管理システムを提供し、顧客がオンラインで簡単に予約できる環境を構築する。

### 1.2 システム構成
- **フロントエンド**: Nuxt 3 + Tailwind CSS（Cloudflare Pages）
- **バックエンド**: Nuxt 3 Server API（Cloudflare Workers）
- **データベース**: Cloudflare D1（SQLite）
- **ファイルストレージ**: Cloudflare R2
- **メール送信**: MailChannels

## 2. アーキテクチャ設計

### 2.1 全体構成図（モード切り替え対応）
```
┌────────────────────────────────────────────────────────┐
│             Appointy統一システム                          │
│  ┌─────────────────┐     ┌─────────────────┐          │
│  │  お客さまモード   │◄────┤   店舗モード     │          │
│  │   (白ヘッダー)    │     │   (青ヘッダー)    │          │
│  │  顧客端末       │     │  オーナー端末    │          │
│  └────────┬────────┘     └────────┬────────┘          │
│           │                       │                   │
│           └───────────┬───────────┘                   │
│                       │                               │
│                ┌──────▼──────┐                       │
│                │ Cloudflare  │                       │
│                │   Pages     │                       │
│                │ (Frontend)  │                       │
│                │ AppHeader   │◄──モード切り替え機能     │
│                └──────┬──────┘                       │
│                       │                               │
│                ┌──────▼──────┐                       │
│                │ Cloudflare  │                       │
│                │  Workers    │                       │
│                │ (Backend)   │                       │
│                └──┬────┬────┬─┘                      │
│                   │    │    │                        │
│      ┌────────────▼┐  ┌▼────┐┌▼──────────┐           │
│      │Cloudflare D1│  │ R2  ││MailChannels│           │
│      │ (Database)  │  │     ││            │           │
│      └─────────────┘  └─────┘└────────────┘           │
└────────────────────────────────────────────────────────┘
```

### 2.2 レイヤー構成
1. **プレゼンテーション層**
   - Vue 3コンポーネント（Nuxt 3）
   - Tailwind CSSによるスタイリング

2. **アプリケーション層**
   - Nuxt 3 Server API
   - 認証・認可処理
   - ビジネスロジック実装

3. **データ層**
   - Cloudflare D1（SQLite）
   - Cloudflare R2（オブジェクトストレージ）

### 2.3 UI/UXアーキテクチャ（モード切り替えシステム）

#### デュアルモード設計
```
┌─────────────────────────────────────────────────────┐
│                AppHeader.vue                        │
│  ┌─────────────────┐    ┌─────────────────┐       │
│  │  お客さまモード   │◄──┤   店舗モード     │       │
│  │ (userType:       │   │ (userType:      │       │
│  │  'customer')     │   │  'owner')       │       │
│  │                 │   │                 │       │
│  │ • 白背景        │   │ • 青背景        │       │
│  │ • 予約中心UI    │   │ • 管理中心UI    │       │
│  │ • マイページ    │   │ • ダッシュボード  │       │
│  └─────────────────┘    └─────────────────┘       │
└─────────────────────────────────────────────────────┘
```

#### コンポーネント設計原則
- **統一ヘッダー**: AppHeader.vueで全モード管理
- **動的スタイリング**: computed propertiesによる自動切り替え
- **状態管理**: userTypeプロパティとwatcherによる反応性
- **一貫性**: 同じコンポーネントで統一された操作感

## 3. セキュリティ設計

### 3.1 認証・認可
- **認証方式**: JWTトークンベース認証
- **パスワード**: bcryptによるハッシュ化
- **セッション管理**: HTTPOnly Cookieに保存

### 3.2 アクセス制御
- 店舗オーナー専用エンドポイントの保護
- CORSポリシーの適切な設定
- CSRFトークンによる保護

### 3.3 データ保護
- HTTPS通信の強制
- SQLインジェクション対策（プリペアドステートメント使用）
- XSS対策（Vue.jsの自動エスケープ機能）

## 4. 画面設計

### 4.1 統一認証システム画面
| 画面名 | パス | 説明 |
|--------|------|------|
| トップページ | `/` | ランディングページ、サービス紹介 |
| 統一ログイン | `/login` | 全ユーザー共通ログイン |
| 統一登録 | `/register` | 全ユーザー共通新規登録 |

### 4.2 顧客モード画面（白ヘッダー）
| 画面名 | パス | 説明 |
|--------|------|------|
| サービス一覧 | `/booking` | 全店舗のサービス一覧表示 |
| 個別サービス予約 | `/store/[storeId]/service/[serviceId]` | 個別サービスの詳細・予約ページ |
| ダッシュボード | `/dashboard` | ユーザーダッシュボード |
| 予約履歴 | `/reservations` | 予約履歴・キャンセル機能 |
| プロフィール | `/profile` | ユーザー情報編集 |
| 店舗開設 | `/store/register` | 店舗開設申請 |

### 4.3 店舗モード画面（青ヘッダー）
| 画面名 | パス | 説明 |
|--------|------|------|
| 店舗ダッシュボード | `/owner/dashboard` | 店舗統計・予約状況 |
| サービス管理 | `/owner/services` | サービスのCRUD操作 |
| 予約管理 | `/owner/reservations` | 予約一覧・詳細確認 |
| 店舗設定 | `/owner/settings` | 店舗情報・営業時間設定 |

## 5. API設計

### 5.1 統一認証API
- `/api/auth/login` - 統一ログイン
- `/api/auth/register` - 統一ユーザー登録
- `/api/auth/me` - 認証ユーザー情報取得
- `/api/auth/logout` - ログアウト

### 5.2 プロフィールAPI（認証必須）
- `/api/profile` - ユーザープロフィール更新
- `/api/profile/image` - プロフィール画像管理

### 5.3 店舗登録API（認証必須）
- `/api/store/register` - 店舗登録（1ユーザー1店舗）

### 5.4 顧客API（認証必須）
- `/api/customer/reservations` - 予約履歴取得
- `/api/customer/reservations/[id]/cancel` - 予約キャンセル

### 5.5 店舗管理API（店舗所有必須）
- `/api/owner/services/*` - サービス管理
- `/api/owner/reservations/*` - 予約管理
- `/api/owner/profile/*` - 店舗プロフィール管理

### 5.6 公開API
- `/api/public/profile` - 店舗プロフィール取得
- `/api/public/services/*` - サービス一覧・詳細取得
- `/api/public/available-slots` - 予約可能時間取得
- `/api/public/reservations` - 予約作成（認証必須）

## 6. 機能設計

### 6.1 統一認証機能
- 統一ログイン/ログアウト
- JWTトークンベースセッション管理
- 段階的権限管理（ユーザー → 店舗運営者）
- 1ユーザー1店舗制限

### 6.2 デュアルモードシステム
- 顧客モード（白ヘッダー）
- 店舗モード（青ヘッダー）
- ワンクリックモード切り替え
- 動的ヘッダー制御

### 6.3 マルチテナント対応
- store_idベースのデータ分離
- 複数店舗の独立運営
- 全店舗サービス表示

### 6.4 予約システム
- 認証必須予約作成
- 予約履歴・キャンセル機能
- 予約可能時間の自動計算
- 24時間前キャンセル制限

### 6.5 サービス管理機能
- サービスのCRUD操作
- カテゴリ管理
- 料金・所要時間設定
- アクティブ/非アクティブ管理

### 6.6 プロフィール管理機能
- ユーザー基本情報編集
- 店舗情報管理
- プロフィール画像アップロード
- 営業時間設定

### 6.7 通知機能（将来実装）
- 予約確認メール送信
- リマインドメール送信
- キャンセル通知

## 7. 非機能要件

### 7.1 パフォーマンス
- ページロード時間: 3秒以内
- API応答時間: 1秒以内
- 同時接続数: 100ユーザー

### 7.2 可用性
- Cloudflareのグローバルネットワークによる高可用性
- 自動スケーリング対応

### 7.3 拡張性
- マイクロサービスアーキテクチャ
- APIファーストな設計

## 8. 開発・デプロイ戦略

### 8.1 開発環境
- VSCode DevContainer使用
- SQLite（ローカル開発）
- MinIO（R2の代替）

### 8.2 デプロイメント
- GitHubからCloudflare Pagesへの自動デプロイ
- 環境変数による設定管理
- ステージング環境の構築

## 9. 監視・運用

### 9.1 ログ管理
- Cloudflare Workers Logsの活用
- エラー通知の設定

### 9.2 メトリクス
- アクセス数の監視
- API応答時間の監視
- エラー率の監視

### 9.3 バックアップ
- D1データベースの定期バックアップ
- R2オブジェクトのバージョニング